version: "3.8"

services:
  ip-certgen:
    image: alpine:3.19
    container_name: flowlet-ip-certgen
    environment:
      FLOWLET_PUBLIC_HOST: ${FLOWLET_PUBLIC_HOST}
      CERT_DIR: /certs
    volumes:
      - ip_certs:/certs
      - ./ip-certgen.sh:/usr/local/bin/ip-certgen.sh:ro
    command: ["sh", "-c", "apk add --no-cache openssl && /usr/local/bin/ip-certgen.sh"]
    restart: "no"

  nginx:
    image: nginx:1.27-alpine
    container_name: flowlet-nginx
    ports:
      - "5173:5173"
      - "8443:8443"
    environment:
      FLOWLET_PUBLIC_HOST: ${FLOWLET_PUBLIC_HOST}
    volumes:
      - ./nginx-ip.conf:/etc/nginx/templates/default.conf.template:ro
      - ip_certs:/etc/nginx/certs:ro
    depends_on:
      ip-certgen:
        condition: service_completed_successfully

  keycloak-db:
    image: postgres:15-alpine
    container_name: flowlet-keycloak-db
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: keycloak123
    volumes:
      - keycloak_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U keycloak -d keycloak"]
      interval: 5s
      timeout: 5s
      retries: 5

  keycloak:
    image: quay.io/keycloak/keycloak:26.4
    container_name: flowlet-keycloak
    command: start
    environment:
      KC_BOOTSTRAP_ADMIN_USERNAME: ${KEYCLOAK_ADMIN_USER:-admin}
      KC_BOOTSTRAP_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-admin123}
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://keycloak-db:5432/keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: keycloak123
      KC_HTTP_ENABLED: "true"
      KC_PROXY: edge
      KC_PROXY_HEADERS: xforwarded
      KC_HOSTNAME: ${FLOWLET_PUBLIC_HOST}
      KC_HOSTNAME_STRICT: "false"
      KC_HOSTNAME_STRICT_HTTPS: "true"
      KC_HOSTNAME_URL: ${KEYCLOAK_PUBLIC_URL}
      KC_HOSTNAME_ADMIN_URL: ${KEYCLOAK_PUBLIC_URL}
      KC_HEALTH_ENABLED: "true"
      KC_METRICS_ENABLED: "true"
    volumes:
      - ./keycloak-theme:/opt/keycloak/themes
    depends_on:
      keycloak-db:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "bash -c 'exec 3<>/dev/tcp/127.0.0.1/9000'"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 30s

  keycloak-init:
    image: alpine:3.19
    container_name: flowlet-keycloak-init
    depends_on:
      keycloak:
        condition: service_healthy
    volumes:
      - ../flowlet-backend/scripts/keycloak-init.sh:/init/keycloak-init.sh:ro
    environment:
      KEYCLOAK_URL: http://keycloak:8080
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN_USER:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-admin123}
      FLOWLET_REALM: ${FLOWLET_REALM:-flowlet}
      FLOWLET_CLIENT_ID: ${FLOWLET_CLIENT_ID:-flowlet-app}
      FLOWLET_HOSTS: ${FLOWLET_HOSTS}
      FLOWLET_FRONTEND_SCHEME: https
      FLOWLET_FRONTEND_PORT: "5173"
      FLOWLET_BACKEND_SCHEME: https
      FLOWLET_BACKEND_PORT: "5173"
      FLOWLET_ALLOW_HTTP: "false"
      FLOWLET_ENABLE_OFFLINE_ACCESS: ${FLOWLET_ENABLE_OFFLINE_ACCESS:-true}
      KEYCLOAK_FRONTEND_URL: ${KEYCLOAK_FRONTEND_URL}
    command: ["sh", "-c", "apk add --no-cache bash curl jq && bash /init/keycloak-init.sh"]
    restart: "no"

  backend:
    build:
      context: ..
      dockerfile: docker/Dockerfile.backend
    container_name: flowlet-backend
    environment:
      SPRING_PROFILES_ACTIVE: prod
      FLOWLET_OIDC_ISSUER: ${FLOWLET_OIDC_ISSUER}
      FLOWLET_MODEL_HUB_KEY: ${FLOWLET_MODEL_HUB_KEY:-}
      FLOWLET_CODE_EXECUTOR_BASE_URL: http://flowlet-code-executor:18090
      FLOWLET_VECTOR_STORE_BASE_URL: http://flowlet-vector-stores:18091
      FLOWLET_CA_CERT_PATH: /ip-certs/server.crt
    volumes:
      - flowlet_data:/app/data
      - ip_certs:/ip-certs:ro
    depends_on:
      keycloak:
        condition: service_healthy
      flowlet-code-executor:
        condition: service_started
      flowlet-vector-stores:
        condition: service_started
    expose:
      - "8080"

  frontend:
    build:
      context: ..
      dockerfile: docker/Dockerfile.frontend
      args:
        VITE_KEYCLOAK_URL: ${VITE_KEYCLOAK_URL}
        VITE_KEYCLOAK_CLIENT_ID: ${FLOWLET_CLIENT_ID:-flowlet-app}
    container_name: flowlet-frontend
    depends_on:
      - backend
    expose:
      - "80"

  flowlet-code-executor:
    build:
      context: ../flowlet-code-executor
      dockerfile: Dockerfile
    container_name: flowlet-code-executor
    expose:
      - "18090"

  flowlet-vector-stores:
    build:
      context: ../flowlet-vector-stores
      dockerfile: Dockerfile
    container_name: flowlet-vector-stores
    expose:
      - "18091"

volumes:
  keycloak_postgres_data:
  flowlet_data:
  ip_certs:
