version: "3.8"

services:
  caddy:
    image: caddy:2.8
    container_name: flowlet-caddy
    ports:
      - "80:80"
      - "443:443"
      - "5173:80"
    environment:
      APP_DOMAIN: ${APP_DOMAIN:-localhost}
      AUTH_DOMAIN: ${AUTH_DOMAIN:-localhost}
      ACME_EMAIL: ${ACME_EMAIL:-}
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config

  keycloak-db:
    image: postgres:15-alpine
    container_name: flowlet-keycloak-db
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: keycloak123
    volumes:
      - keycloak_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U keycloak -d keycloak"]
      interval: 5s
      timeout: 5s
      retries: 5

  keycloak:
    image: quay.io/keycloak/keycloak:26.4
    container_name: flowlet-keycloak
    command: start
    environment:
      KC_BOOTSTRAP_ADMIN_USERNAME: ${KEYCLOAK_ADMIN_USER:-admin}
      KC_BOOTSTRAP_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-admin123}
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://keycloak-db:5432/keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: keycloak123
      KC_HTTP_ENABLED: "true"
      KC_PROXY: edge
      KC_PROXY_HEADERS: xforwarded
      KC_HOSTNAME: ${KEYCLOAK_HOSTNAME:-localhost}
      KC_HOSTNAME_STRICT: "false"
      KC_HOSTNAME_STRICT_HTTPS: "false"
      KC_HOSTNAME_URL: ${KEYCLOAK_PUBLIC_URL:-http://localhost:8180}
      KC_HOSTNAME_ADMIN_URL: ${KEYCLOAK_PUBLIC_URL:-http://localhost:8180}
      KC_HEALTH_ENABLED: "true"
      KC_METRICS_ENABLED: "true"
    ports:
      - "8180:8080"
      - "9000:9000"
    volumes:
      - ./keycloak-theme:/opt/keycloak/themes
    depends_on:
      keycloak-db:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "bash -c 'exec 3<>/dev/tcp/127.0.0.1/9000'"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 30s

  keycloak-init:
    image: alpine:3.19
    container_name: flowlet-keycloak-init
    depends_on:
      keycloak:
        condition: service_healthy
    volumes:
      - ../flowlet-backend/scripts/keycloak-init.sh:/init/keycloak-init.sh:ro
    environment:
      KEYCLOAK_URL: http://keycloak:8080
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN_USER:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-admin123}
      FLOWLET_REALM: ${FLOWLET_REALM:-flowlet}
      FLOWLET_CLIENT_ID: ${FLOWLET_CLIENT_ID:-flowlet-app}
      FLOWLET_HOSTS: ${FLOWLET_HOSTS:-localhost,127.0.0.1}
      FLOWLET_FRONTEND_SCHEME: ${FLOWLET_FRONTEND_SCHEME:-http}
      FLOWLET_FRONTEND_PORT: ${FLOWLET_FRONTEND_PORT:-5173}
      FLOWLET_BACKEND_SCHEME: ${FLOWLET_BACKEND_SCHEME:-http}
      FLOWLET_BACKEND_PORT: ${FLOWLET_BACKEND_PORT:-8080}
      FLOWLET_ALLOW_HTTP: "true"
      FLOWLET_ENABLE_OFFLINE_ACCESS: ${FLOWLET_ENABLE_OFFLINE_ACCESS:-false}
      KEYCLOAK_FRONTEND_URL: ${KEYCLOAK_FRONTEND_URL:-http://localhost:8180}
    command: ["sh", "-c", "apk add --no-cache bash curl jq && bash /init/keycloak-init.sh"]
    restart: "no"

  backend:
    build:
      context: ..
      dockerfile: docker/Dockerfile.backend
    container_name: flowlet-backend
    environment:
      SPRING_PROFILES_ACTIVE: prod
      FLOWLET_OIDC_ISSUER: ${FLOWLET_OIDC_ISSUER:-http://localhost:8180/realms/${FLOWLET_REALM:-flowlet}}
      FLOWLET_MODEL_HUB_KEY: ${FLOWLET_MODEL_HUB_KEY:-}
      FLOWLET_CODE_EXECUTOR_BASE_URL: http://flowlet-code-executor:18090
      FLOWLET_VECTOR_STORE_BASE_URL: http://flowlet-vector-stores:18091
    volumes:
      - flowlet_data:/app/data
    ports:
      - "8080:8080"
    depends_on:
      keycloak:
        condition: service_healthy
      flowlet-code-executor:
        condition: service_started
      flowlet-vector-stores:
        condition: service_started

  frontend:
    build:
      context: ..
      dockerfile: docker/Dockerfile.frontend
      args:
        VITE_KEYCLOAK_URL: ${VITE_KEYCLOAK_URL:-http://localhost:8180/realms/${FLOWLET_REALM:-flowlet}}
        VITE_KEYCLOAK_CLIENT_ID: ${FLOWLET_CLIENT_ID:-flowlet-app}
    container_name: flowlet-frontend
    depends_on:
      - backend

  flowlet-code-executor:
    build:
      context: ../flowlet-code-executor
      dockerfile: Dockerfile
    container_name: flowlet-code-executor
    ports:
      - "18090:18090"

  flowlet-vector-stores:
    build:
      context: ../flowlet-vector-stores
      dockerfile: Dockerfile
    container_name: flowlet-vector-stores
    ports:
      - "18091:18091"

volumes:
  keycloak_postgres_data:
  flowlet_data:
  caddy_data:
  caddy_config:
